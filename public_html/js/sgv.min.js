var Dispatcher={graphDeleted:()=>{sgv.SPS.reset(),sgv.SPS.refresh(),sgv.dlgCPL.setModeSelection(),sgv.dlgCellView.hide()},graphChanged:()=>{sgv.dlgCPL.updateSliders(),sgv.dlgCellView.refresh(),sgv.SPS.refresh()},currentScopeChanged:()=>{sgv.dlgCPL.updateSliders(),sgv.dlgCellView.refresh(),sgv.SPS.refresh()},viewModeChanged:()=>{sgv.dlgCellView.refresh(),sgv.SPS.refresh()}},SPS=function(e){var i=new BABYLON.SolidParticleSystem("NodeSPS",e,{isPickable:!0,expandable:!0,enableDepthSort:!0}),r=new BABYLON.SolidParticleSystem("EdgeSPS",e,{isPickable:!0,expandable:!0,enableDepthSort:!0}),n=0,a=0,t=[],s=[],l=BABYLON.MeshBuilder.CreateSphere("defaultSphere",{diameter:3,segments:8,updatable:!1}),o=BABYLON.MeshBuilder.CreateCylinder("cylinder",{height:1,diameter:1,tessellation:6,updatable:!1});function d(){i.setParticles(),i.refreshVisibleSize(),r.setParticles(),r.refreshVisibleSize()}return l.setEnabled(!1),o.setEnabled(!1),{init:function(){i.addShape(l,100),r.addShape(o,100),i.buildMesh(),r.buildMesh();for(let e=0;e<100;e++)i.particles[e].isVisible=!1,r.particles[e].isVisible=!1;d()},reset:function(){n=a=0},onPick:function(e){var t=e.pickedMesh.name;return t===i.name?{type:"node",id:i.particles[i.pickedParticle(e).idx].nodeId}:t===r.name?{type:"edge",id:r.particles[r.pickedParticle(e).idx].edgeId}:{type:"unknown",id:-1}},refresh:d,bindNode:function(e,t,n){var s=function(){var e=a++,t=i.nbParticles;if(t<=e){i.addShape(l,100),i.buildMesh();for(let e=t;e<t+100;e++)i.particles[e].isVisible=!1}return e}();return void 0!==(s=i.particles[s])?(s.position=t,s.color=n,s.isVisible=!0,s.nodeId=e.id,s):null},updateNodeValue:function(e,t){e=e.meshId(),(e=i.particles[e]).color=t,e.isVisible=!0},unbindNode:function(e){e=e.meshId(),i.particles[e].isVisible=!1,i.particles[e].nodeId=null,t.push(e)},bindEdge:function(e){var t=function(){var e=n++,t=r.nbParticles;if(t<=e){r.addShape(o,100),r.buildMesh();for(let e=t;e<t+100;e++)r.particles[e].isVisible=!1}return e}();return void 0!==(t=r.particles[t])?(t.edgeId=e.id,t):null},setEdge:function(e,t,n,s,i){var e=e.meshId(),e=r.particles[e],a=BABYLON.Vector3.Distance(s,i),l=i.subtract(s),o=(l.normalize(),new BABYLON.Vector3);o.copyFrom(s),o.addInPlace(l.scale(a/2)),e.rotation=PitchYawRollToMoveBetweenPoints(s,i),e.position=o,e.color=t,e.scaling=new BABYLON.Vector3(n,a,n),e.isVisible=!0},updateEdgeGeometry:function(e,t,n){var e=e.meshId(),e=r.particles[e],s=BABYLON.Vector3.Distance(t,n),i=n.subtract(t),a=(i.normalize(),new BABYLON.Vector3);a.copyFrom(t),a.addInPlace(i.scale(s/2)),e.rotation=PitchYawRollToMoveBetweenPoints(t,n),e.position=a,e.isVisible=!0},updateEdgeValue:function(e,t,n){e=e.meshId(),(e=r.particles[e]).color=t,e.scaling.x=n,e.scaling.z=n,e.isVisible=!0},unbindEdge:function(e){e=e.meshId(),r.particles[e].isVisible=!1,r.particles[e].edgeId=null,s.push(e)}}};const DEMO_MODE=!1;function valueToColor(e){var t,n,s,i;return null==e||isNaN(e)?new BABYLON.Color3(.9,.9,.9):DEMO_MODE?0===e?new BABYLON.Color3(0,0,1):-1===e?new BABYLON.Color3(1,0,0):1===e?new BABYLON.Color3(0,1,0):.5===e?new BABYLON.Color3(1,.65,0):-.5===e?new BABYLON.Color3(1,0,1):new BABYLON.Color3(.9,.9,.9):(i=sgv.graf.greenLimit,t=sgv.graf.redLimit,i=0<e?(n=0,1-(s=e<i?e/i:1)):e<0?(s=0,1-(n=t<e?e/t:1)):(s=n=0,1),new BABYLON.Color3(n,s,i))}function valueToColorBAK(e){var t,n,s,i;return null==e||isNaN(e)?new BABYLON.Color3(.9,.9,.9):(i=sgv.graf.greenLimit,t=sgv.graf.redLimit,i=0<e?(s=e<i?e/i:1,n=0):s=e<0?(n=t<e?e/t:1,0):n=0,new BABYLON.Color3(n,s,i))}function valueToEdgeWidth(e){var t,n;return DEMO_MODE||null==e||isNaN(e)||(n=Math.abs(sgv.graf.greenLimit),n=(t=Math.abs(sgv.graf.redLimit))<n?n:t,0===e)||0===n?.2:n<(e=Math.abs(e))?1.2:.2+e/n}var Def2=(e,t)=>{this.n1=e,this.n2=t,this.values={default:Number.NaN},this.label={text:null,enabled:!1}},TempGraphStructure=function(){this.nodes=[],this.edges=[],this.addEdge1=function(e,t,n){this.edges.push({n1:e,n2:t,values:{default:n}})},this.addNode1=function(e,t,n){t={id:e,values:{default:t},label:{text:e,enabled:!1}};void 0!==n&&(t.label.text=n,t.label.enabled=!0),this.nodes.push(t)}};function PitchYawRollToMoveBetweenPointsToRef(e,t,n){var s=BABYLON.TmpVectors.Vector3[0];return t.subtractToRef(e,s),n.y=Math.atan2(s.x,s.z)||0,n.x=Math.atan2(Math.sqrt(s.x**2+s.z**2),s.y)||0,n.z=0,n}function PitchYawRollToMoveBetweenPoints(e,t){return PitchYawRollToMoveBetweenPointsToRef(e,t,BABYLON.Vector3.Zero())}var Label=function(e,t,n,s){this.setText=async function(e,t){this.text=e,null!==this.plane&&this.plane.dispose(),this.plane=this.createPlane(),this.plane.position=this.position.add(new BABYLON.Vector3(0,5,0)),this.plane.billboardMode=BABYLON.AbstractMesh.BILLBOARDMODE_ALL,this.plane.setEnabled(t),this.plane.isPickable=!1},this.getText=function(){return this.text},this.setPosition=function(e){this.position=e,null!==this.plane&&(this.plane.position=e.add(this.planeOffset))},this.createPlane=function(){var e="bold 64px Arial",t=new BABYLON.DynamicTexture("DynamicTexture",64,sgv.scene).getContext(),t=(t.font=e,t.measureText(this.text).width+8),n=BABYLON.MeshBuilder.CreatePlane(this.id+"_plane",{width:.075*t,height:72*.075,updatable:!0},sgv.scene);return n.material=new BABYLON.StandardMaterial(this.id+"_plane_material",sgv.scene),n.material.diffuseTexture=new BABYLON.DynamicTexture(this.id+"_plane_texture",{width:t,height:72},sgv.scene,!1),n.material.diffuseTexture.hasAlpha=!0,n.material.opacityTexture=n.material.diffuseTexture,n.material.transparencyMode=BABYLON.Material.MATERIAL_ALPHABLEND,n.material.alpha=1,n.material.diffuseTexture.drawText(this.text,null,null,e,"#ffff00","rgba(0,0,255,0.7)",!0),n.material.emissiveColor=new BABYLON.Color3(1,1,0),n},this.createMe=async function(e,t){this.plane=this.createPlane(),this.plane.position=e.add(this.planeOffset),this.plane.billboardMode=BABYLON.AbstractMesh.BILLBOARDMODE_ALL,this.plane.setEnabled(t),this.plane.isPickable=!1},this.setEnabled=function(e){null!==this.plane&&this.plane.setEnabled(e)},this.text=t,this.planeOffset=new BABYLON.Vector3(0,5,0),this.position=n,this.id=e,this.plane=null,this.createMe(n,s)};const createLabel=function(e,t,n,s){return new Label("q"+e,"q"+e,t,n,s)};var Node=function(e,t,n,s,i,a){var l;this.parentGraph=e,"number"!=typeof(t="string"==typeof t?parseInt(t,10):t)&&console.warning("Node id should be a number, but is: "+t),this.id=t,this.active=!0,this._chckedEdges=0,this.labelIsVisible=!1,this.values={default:Number.NaN};for(const o in a)this.values[o]=a[o];Object.defineProperty(this,"position",{get(){return this.mesh.position},set(e){this.mesh.position.copyFrom(e),void 0!==l&&l.plane.position.copyFrom(e)}}),this.dispose=function(){sgv.SPS.unbindNode(this),null!==l.plane&&l.plane.dispose(),delete this.label},this.clear=function(){this.dispose()},this.showLabel=function(e){void 0!==e&&(this.labelIsVisible=e),l.setEnabled(this.labelIsVisible&&this.parentGraph.labelsVisible)},this.setLabel=function(e,t){void 0!==t&&(this.labelIsVisible=t),l.setText(e,this.labelIsVisible&&this.parentGraph.labelsVisible)},this.isLabelVisible=function(){return this.labelIsVisible},this.getLabel=function(){return l.getText()},this.move=function(e){this.mesh.position.addInPlace(e)},this.addCheck=function(){this._chckedEdges++},this.delCheck=function(){this._chckedEdges--},this.getValue=function(e){return void 0===e&&(e=this.parentGraph.currentScope),this.values.hasOwnProperty(e)?this.values[e]:Number.NaN},this.delValue=function(e){(e=void 0===e?this.parentGraph.currentScope:e)in this.values&&delete this.values[e]},this.setValue=function(e,t){void 0===t&&(t=this.parentGraph.currentScope),this.values[t]=e},this.displayValue=function(e){e=valueToColor((e=void 0===e?this.parentGraph.currentScope:e)in this.values?this.values[e]:Number.NaN);sgv.SPS.updateNodeValue(this,e)},this.currentColor=function(e){return(e=void 0===e?this.parentGraph.currentScope:e)in this.values?valueToColor(this.values[e]):new BABYLON.Color4(.2,.2,.2)},this.meshId=()=>this.mesh.idx,this.mesh=sgv.SPS.bindNode(this,new BABYLON.Vector3(n,s,i),this.currentColor()),null===this.mesh?console.error("Can't bind NodeSPS"):l=createLabel(this.id,this.mesh.position,sgv.scene,!1)},Edge=function(e,t,n){this.parentGraph=e,this.values={default:Number.NaN},"string"==typeof t&&(t=parseInt(t,10)),"string"==typeof n&&(n=parseInt(n,10)),"number"==typeof t&&"number"==typeof n||console.warning("Edge begin and end ids should be both a numbers, but are: "+t+" and "+n),t in this.parentGraph.nodes||console.warning("First node not exists in graph: "+t),n in this.parentGraph.nodes||console.warning("Second node not exists in graph: "+n),t<n?(this.begin=t,this.end=n):(this.begin=n,this.end=t),this.id=Edge.calcId(this.begin,this.end),this._checked=!1,this.meshId=()=>s.idx,this.clear=function(){sgv.SPS.unbindEdge(this)},this.switchCheckFlag=function(){this._checked=!this._checked,this.parentGraph.checkNode(this.begin,this._checked),this.parentGraph.checkNode(this.end,this._checked)},this.delValue=function(e){(e=void 0===e?this.parentGraph.currentScope:e)in this.values&&delete this.values[e]},this.getValue=function(e){return void 0===e&&(e=this.parentGraph.currentScope),this.values.hasOwnProperty(e)?this.values[e]:Number.NaN},this.setValue=function(e,t){this.values[t=void 0===t?"default":t]=e,this.displayValue(t)},this.displayValue=function(e){void 0===e&&(e="default");let t=new BABYLON.Color3(.2,.2,.2),n=.1;e in this.values&&(t=valueToColor(this.values[e]),n=valueToEdgeWidth(this.values[e])),sgv.SPS.updateEdgeValue(this,t,n)},this.update=()=>{var e=this.values[this.parentGraph.currentScope],t=valueToColor(e),e=valueToEdgeWidth(e),n=this.parentGraph.nodePosition(this.begin),s=this.parentGraph.nodePosition(this.end);sgv.SPS.setEdge(this,t,e,n,s)};var s=sgv.SPS.bindEdge(this);null===s?console.error("Can't bind EdgeSPS"):this.update()};Edge.calcId=(e,t)=>("string"==typeof e&&(e=parseInt(e,10)),"string"==typeof t&&(t=parseInt(t,10)),"number"==typeof e&&"number"==typeof t||console.error("Edge begin and end must be a numbers"),e<t?e+","+t:t+","+e);const qD=function(e,t,n,s,i,a){return new QbDescr(e,t,n,s,i,a)},QbDescr=function(e,t,n,s,i,a){this.x=e,this.y=t,this.z=n,this.i=s,this.j=i,this.k=a,this.n0=function(){return((this.i<<1)+this.j<<1)+this.k},this.n1=function(){return((this.i<<1)+this.j<<1)+this.k+1},this.toNodeId=function(e,t){return 8*(this.x+(this.y+this.z*e)*t)+this.n1()}};QbDescr.fromNodeId=function(e,t,n){var e=e-1,s=e%8,i=s%2,a=(s>>1)%2,s=(s>>2)%2,e=e>>3,t=n*t,l=Math.floor(e/t),e=e%t,t=Math.floor(e/n),e=e%n;return new QbDescr(e,t,l,s,a,i)};var Graph=function(){this.nodes={},this.edges={},this.missing={},this.type="generic",this.scopeOfValues=["default"],this.currentScope="default",this.greenLimit=1,this.redLimit=-1,this.labelsVisible=!1,this.dispose=function(){for(const e in this.edges)this.edges[e].clear(),delete this.edges[e];for(const t in this.nodes)this.nodes[t].clear(),delete this.nodes[t];Dispatcher.graphDeleted()},this.clear=function(){this.dispose()},this.maxNodeId=function(){return Object.keys(this.nodes).length},this.addNode=function(e,t,n){values={},"number"==typeof n&&(values.default=n);n=new Node(this,e,t.x,t.y,t.z,values);return this.nodes[n.id]=n},this.getKeyByValue=function(t,n){return Object.keys(t).find(e=>t[e]===n)},this.getScopeIndex=function(t){return Object.keys(this.scopeOfValues).find(e=>this.scopeOfValues[e]===t)},this.addEdge=function(e,t){var n=Edge.calcId(e,t);return n in this.edges?(console.log("edge already exists",n),this.edges[n]):(e=new Edge(this,e,t),this.edges[n]=e)},this.delEdge=function(e){this.edges[e].clear(),delete this.edges[e],Dispatcher.graphChanged()},this.findAllConnected=s=>{var i={internal:[],horizontal:[],vertical:[],up:[],down:[],other:[]};function e(e){var t=QbDescr.fromNodeId(s,sgv.graf.rows,sgv.graf.cols),n=QbDescr.fromNodeId(e,sgv.graf.rows,sgv.graf.cols);(t.x===n.x&&t.y===n.y&&t.z===n.z?i.internal:t.x!==n.x&&t.y===n.y&&t.z===n.z?i.horizontal:t.x===n.x&&t.y!==n.y&&t.z===n.z?i.vertical:t.z<n.z?i.up:t.z>n.z?i.down:i.other).push(e)}for(const t in this.edges)this.edges[t].begin===s?e(this.edges[t].end):this.edges[t].end===s&&e(this.edges[t].begin);return i},this.findAndDeleteEdges=function(e){var t={};console.log("graf.findAndDeleteEdges",e);for(const n in this.edges)this.edges[n].begin.toString()===e?(t[this.edges[n].end]={values:this.edges[n].values},this.delEdge(n)):this.edges[n].end.toString()===e&&(t[this.edges[n].begin]={values:this.edges[n].values},this.delEdge(n));return t},this.delNode=function(e){var t=this.findAndDeleteEdges(e);this.missing[e]={label:{text:this.nodes[e].getLabel(),enabled:this.nodes[e].isLabelVisible()},values:this.nodes[e].values,edges:{}};for(const n in t)this.missing[e].edges[n]=t[n];this.nodes[e].clear(),delete this.nodes[e],sgv.dlgMissingNodes.addNode(e),Dispatcher.graphChanged()},this.restoreNode=function(e){if(e in this.nodes)return!1;if(!(e in this.missing))return!1;var t=this.calcPosition(e);this.nodes[e]=new Node(this,e,t.x,t.y,t.z,this.missing[e].values),this.nodes[e].setLabel(this.missing[e].label.text,this.missing[e].label.enabled);for(const i in this.missing[e].edges){var n=parseInt(i,10);if(n in this.nodes){var s=new Edge(this,e,i);console.log(s);for(const a in this.missing[e].edges[n].values)s.setValue(this.missing[e].edges[n].values[a],a);this.edges[s.id]=s,console.log(s.id)}else n in this.missing&&(this.missing[n].edges[e]=this.missing[e].edges[n])}return delete this.missing[e],0===Object.keys(this.missing).length&&sgv.dlgMissingNodes.hide(),Dispatcher.graphChanged(),!0},this.findAndUpdateEdges=function(e){for(const t in this.edges)this.edges[t].begin.toString()!==e&&this.edges[t].end.toString()!==e||this.edges[t].update()},this.stringToStruct=e=>{if(null==e)return null;for(var t,n={nodes:{},edges:{}},s=e.split("\n");0<s.length;)"#"!==s[0][0]&&null!==(t=function(e){e=e.split(" ");return 3===e.length?{n1:parseInt(e[0],10),n2:parseInt(e[1],10),val:parseFloat(e[2],10)}:null}(s[0]))&&(t.n1===t.n2?n.nodes[t.n1]=t.val:n.edges[Edge.calcId(t.n1,t.n2)]=t.val),s.shift();return n},this.loadScopeValues=(e,t)=>{let n=!1;void 0===e||this.scopeOfValues.includes(e)||(this.scopeOfValues.push(e),n=!0);var s=this.stringToStruct(t);for(const i in s.nodes)this.nodes[i].setValue(s.nodes[i],e);for(const a in s.edges)this.edges[a].setValue(s.edges[a],e);return this.displayValues(e),{n:n,i:this.scopeOfValues.indexOf(e)}},this.addScopeOfValues=function(e){return void 0===e||this.scopeOfValues.includes(e)?-1:(this.scopeOfValues.push(e),this.scopeOfValues.indexOf(e))},this.delScopeOfValues=function(e){if(void 0!==e&&"default"!==e){var t=this.scopeOfValues.indexOf(e);if(-1!==t){this.scopeOfValues.splice(t,1);for(const n in this.nodes)this.nodes[n].delValue(e);return this.currentScope===e&&(this.currentScope="default",this.displayValues("default")),this.scopeOfValues.indexOf(this.currentScope)}}return-1},this.hasScope=function(e){return void 0!==e&&this.scopeOfValues.includes(e)},this.displayValues=async function(e){void 0!==e&&this.scopeOfValues.includes(e)?this.currentScope=e:e=this.currentScope;for(const t in this.nodes)this.nodes[t].displayValue(e);for(const n in this.edges)this.edges[n].displayValue(e);return Dispatcher.currentScopeChanged(),!0},this.nodePosition=function(e){return this.nodes[e].position},this.checkNode=function(e,t){t?this.nodes[e].addCheck():this.nodes[e].delCheck()},this.edgeDoubleClicked=function(e){this.edges[e].switchCheckFlag()},this.moveNode=function(e,t){this.nodes[e].move(t),this.findAndUpdateEdges(e)},this.setEdgeValue=function(e,t,n){this.edges[e].setValue(t,n),this.edges[e].displayValue()},this.delEdgeValue=function(e,t){this.edges[e].delValue(t),this.edges[e].displayValue()},this.edgeValue=function(e,t){return this.edges[e].getValue(t)},this.setNodeValue=function(e,t,n){this.nodes[e].setValue(t,n),this.nodes[e].displayValue()},this.delNodeValue=function(e,t){this.nodes[e].delValue(t),this.nodes[e].displayValue()},this.nodeValue=function(e,t){return this.nodes[e].getValue(t)},this.getMinMaxEdgeVal=function(e){void 0!==e&&this.scopeOfValues.includes(e)||(e=this.currentScope);var t={min:Number.MAX_VALUE,max:-Number.MAX_VALUE,com:""};let n=!0;for(const i in this.edges){var s=this.edges[i].getValue(e);isNaN(s)||(n=!1,s<t.min&&(t.min=s),t.max<s&&(t.max=s))}return n&&(t.min=Number.NaN,t.max=Number.NaN,t.com="\nWARNING: The graph has no edge that has a weight in the current scope.\n"),t},this.getMinMaxNodeVal=function(e){void 0!==e&&this.scopeOfValues.includes(e)||(e=this.currentScope);var t={min:Number.MAX_VALUE,max:-Number.MAX_VALUE,com:""};let n=!0;for(const i in this.nodes){var s=this.nodes[i].getValue(e);isNaN(s)||(n=!1,s<t.min&&(t.min=s),t.max<s&&(t.max=s))}return n&&(t.min=Number.NaN,t.max=Number.NaN,t.com="\nWARNING: The graph has no node that has a value in the current scope.\n"),t},this.getMinMaxVal=function(e){void 0!==e&&this.scopeOfValues.includes(e)||(e=this.currentScope);var t=this.getMinMaxNodeVal(e),e=this.getMinMaxEdgeVal(e);return isNaN(t.min)?{min:e.min,max:e.max}:isNaN(e.min)?{min:t.min,max:t.max}:{min:(t.min<e.min?t:e).min,max:(t.max>e.max?t:e).max}},this.calcPosition=e=>new BABYLON.Vector3,this.changeDisplayMode=function(){for(const t in this.nodes){var e=this.calcPosition(t);this.nodes[t].position=e}for(const n in this.edges)this.edges[n].update();Dispatcher.viewModeChanged()},this.showLabels=function(e){this.labelsVisible=e;for(const t in this.nodes)this.nodes[t].showLabel()},this.createStructureFromDef=function(t){console.log(t);for(let e=0;e<t.length;e++){var n,s;t[e].n1===t[e].n2?(n=t[e].n1,this.addNode(n,this.calcPosition(n),t[e].val),this.nodes[n].showLabel(!1)):(n=t[e].n1,s=t[e].n2,this.addEdge(n,s).setValue(t[e].val,"default"))}},this.createStructureFromDef2=function(t){for(let e=0;e<t.length;e++)if(t[e].n1===t[e].n2){var n=t[e].n1,s=this.addNode(n,this.calcPosition(n),0);for(const l in t[e].values)s.setValue(t[e].values[l],l)}else{var n=t[e].n1,i=t[e].n2,a=this.addEdge(n,i);for(const o in t[e].values)a.setValue(t[e].values[o],o)}this.showLabels(!0),this.displayValues("default")}},Chimera=function(){Graph.call(this),this.type="chimera",this.cols,this.rows,this.KL,this.KR,this.layers=1,this.maxNodeId=function(){return this.cols*this.rows*8},this.connect=function(e,t,n){var e=e.toNodeId(this.rows,this.cols),t=t.toNodeId(this.rows,this.cols);e in this.nodes&&t in this.nodes&&(e=this.addEdge(e,t),"number"==typeof n)&&e.setValue(n)},this.connectRowModules2=function(n,s,i){for(let t=0;t<2;t++)for(let e=0;e<2;e++)this.connect(new QbDescr(n,s,i,0,t,e),new QbDescr(n,s+1,i,0,t,e))},this.connectColModules2=function(n,s,i){for(let t=0;t<2;t++)for(let e=0;e<2;e++)this.connect(new QbDescr(n,s,i,1,t,e),new QbDescr(n+1,s,i,1,t,e))},this.modulePosition=function(e,t,n){t=(this.cols-1)/2*50-50*t,e=50*e-(this.rows-1)/2*50,n=50*n-(this.layers-1)/2*50;return new BABYLON.Vector3(t,n,e)},this.calcPosition2=function(e,t,n,s){e=this.modulePosition(e,t,n);return e.addInPlace(this.getNodeOffset2(s)),e},this.calcPosition=function(e){e=QbDescr.fromNodeId(e,this.rows,this.cols);return this.calcPosition2(e.x,e.y,e.z,e.n0())},this.createModule2=function(t,n,s){var i=8*(t+(n+s*this.rows)*this.cols);for(let e=0;e<this.KL;e++)this.addNode(i+e+1,this.calcPosition2(t,n,s,e),Number.NaN);for(let e=4;e<this.KR+4;e++)this.addNode(i+e+1,this.calcPosition2(t,n,s,e),Number.NaN);for(let t=0;t<this.KL;t++)for(let e=0;e<this.KR;e++)this.addEdge(i+t+1,4+i+e+1)},this.getNodeOffset2=function(e){return{classic:[new BABYLON.Vector3(15,-3,-10),new BABYLON.Vector3(5,-1,-10),new BABYLON.Vector3(-5,1,-10),new BABYLON.Vector3(-15,3,-10),new BABYLON.Vector3(15,3,10),new BABYLON.Vector3(5,1,10),new BABYLON.Vector3(-5,-1,10),new BABYLON.Vector3(-15,-3,10)],diamond:[new BABYLON.Vector3(0,-5,15),new BABYLON.Vector3(0,-1,5),new BABYLON.Vector3(0,1,-5),new BABYLON.Vector3(0,5,-15),new BABYLON.Vector3(15,5,0),new BABYLON.Vector3(5,1,0),new BABYLON.Vector3(-5,-1,0),new BABYLON.Vector3(-15,-5,0)],triangle:[new BABYLON.Vector3(-15,-3,9),new BABYLON.Vector3(-15,-1,3),new BABYLON.Vector3(-15,1,-3),new BABYLON.Vector3(-15,3,-9),new BABYLON.Vector3(9,3,15),new BABYLON.Vector3(3,1,15),new BABYLON.Vector3(-3,-1,15),new BABYLON.Vector3(-9,-3,15)]}[sgv.displayMode][e]},this.rowConnections=()=>{for(let n=0;n<this.layers;n++)for(let t=0;t<this.rows-1;t++)for(let e=0;e<this.cols;e++)this.connectRowModules2(e,t,n)},this.colConnections=()=>{for(let n=0;n<this.layers;n++)for(let t=0;t<this.rows;t++)for(let e=0;e<this.cols-1;e++)this.connectColModules2(e,t,n)},this.createModules=()=>{for(let n=0;n<this.layers;n++)for(let t=0;t<this.rows;t++)for(let e=0;e<this.cols;e++)this.createModule2(e,t,n)},this.createDefaultStructure=function(e){sgv.dlgLoaderSplash.setInfo("creating modules",()=>{this.createModules(),this.showLabels(!0),sgv.dlgLoaderSplash.setInfo("creating row connections",()=>{this.rowConnections(),sgv.dlgLoaderSplash.setInfo("creating col connections",()=>{this.colConnections(),"function"==typeof e&&e()})})})},this.setSize=function(e,t,n,s,i){this.cols=e,this.rows=t,this.KL=n,this.KR=s,this.layers=void 0!==i?i:1}},Pegasus=(Chimera.prototype=Object.create(Chimera.prototype),(Chimera.prototype.constructor=Chimera).createNewGraph=function(e){var t=new Chimera;return t.setSize(e.cols,e.rows,e.KL,e.KR),t},function(){Chimera.call(this),this.type="pegasus",this.pegasusConnections=()=>{for(let n=0;n<this.layers;n++)for(let t=0;t<this.rows;t++)for(let e=0;e<this.cols;e++)this.connectInternalPegasusEdges(e,t,n),this.connectExternalPegasusEdges(e,t,n)},this.createDefaultStructure=function(e){sgv.dlgLoaderSplash.setInfo("creating modules",()=>{this.createModules(),this.showLabels(!0),sgv.dlgLoaderSplash.setInfo("creating row connections",()=>{this.rowConnections(),sgv.dlgLoaderSplash.setInfo("creating col connections",()=>{this.colConnections(),sgv.dlgLoaderSplash.setInfo("creating specific pegasus connections",()=>{this.pegasusConnections(),"function"==typeof e&&e()})})})})},this.connectExternalPegasusEdges=function(s,i,a){let l,o,r,d,c,u,p,g;DEMO_MODE?(l=c=0,o=u=-1,r=p=1,d=g=.5):l=o=r=d=c=u=p=g=Number.NaN;var h=0===s,v=s===this.cols-1,f=0===i,y=i===this.rows-1,b=a===this.layers-1;for(let n=0;n<2;n++)for(let t=0;t<2;t++)for(let e=0;e<2;e++)b?(v||y||(this.connect(new QbDescr(s,i,a,0,0,n),new QbDescr(s+1,i+1,0,1,t,e),c),this.connect(new QbDescr(s,i,a,1,0,n),new QbDescr(s+1,i+1,0,0,t,e),u)),y||this.connect(new QbDescr(s,i,a,0,1,n),new QbDescr(s,i+1,0,1,t,e),p),v||this.connect(new QbDescr(s,i,a,1,1,n),new QbDescr(s+1,i,0,0,t,e),g)):(this.connect(new QbDescr(s,i,a,0,0,n),new QbDescr(s,i,a+1,1,t,e),l),this.connect(new QbDescr(s,i,a,1,0,n),new QbDescr(s,i,a+1,0,t,e),o),h||this.connect(new QbDescr(s,i,a,0,1,n),new QbDescr(s-1,i,a+1,1,t,e),r),f||this.connect(new QbDescr(s,i,a,1,1,n),new QbDescr(s,i-1,a+1,0,t,e),d))},this.connectInternalPegasusEdges=function(e,t,n){let s;s=DEMO_MODE?-.5:Number.NaN;for(var i of[0,1])for(var a of[0,1])this.connect(new QbDescr(e,t,n,i,a,0),new QbDescr(e,t,n,i,a,1),s)}}),UI=(Pegasus.prototype=Object.create(Pegasus.prototype),(Pegasus.prototype.constructor=Pegasus).createNewGraph=function(e){var t=new Pegasus;return void 0!==e.lays?t.setSize(e.cols,e.rows,e.KL,e.KR,e.lays):t.setSize(e.cols,e.rows,e.KL,e.KR),t},function(){});UI.tag=function(e,t,n){var s=document.createElement(e);for(const i in t)s.setAttribute(i,t[i]);for(const a in n)s[a]=n[a];return s},UI.span=function(e,t){return UI.tag("span",t,{textContent:e})},UI.selectByKey=function(e,t){t=UI.findOption(e,t.toString());return-1<t&&(e.selectedIndex=t,!0)},UI.clearSelect=function(e,t){for(var n=t?0:1;n<e.options.length;n++)e.removeChild(e.options[n]),n--},UI.findOption=function(e,t){for(var n=0;n<e.options.length;n++)if(e.options[n].value===t)return n;return-1},UI.option=function(e,t,n){var s=document.createElement("option");return s.value=e,s.text=t,void 0!==n&&(s.selected=n?"selected":""),s},UI.input=function(e){var t=document.createElement("input");for(const n in e)t.setAttribute(n,e[n]);return t},UI.newInput=function(e,t,n,s){var i=document.createElement("input");return i.setAttribute("type",e),i.value=t,void 0!==n&&""!==n&&i.setAttribute("class",n),void 0!==s&&""!==s&&i.setAttribute("id",s),i},UI.createTitlebar=function(e,t){var n=UI.tag("div",{class:"title"});return t&&n.appendChild(UI.tag("input",{type:"button",value:"x",class:"hidebutton"})),n.appendChild(UI.tag("span",{class:"titleText"},{textContent:e})),n},UI.createEmptyWindow=function(e,t,n,s){var i=document.createElement("div");void 0!==e&&""!==e&&i.setAttribute("class",e),void 0!==t&&""!==t&&i.setAttribute("id",t);let a=UI.createTitlebar(n,s);return i.offset={x:0,y:0},i.isDown=!1,a.addEventListener("mouseover",function(){a.style.cursor="pointer",movable=!0}),a.addEventListener("mouseout",function(){movable=!1}),a.addEventListener("mousedown",function(e){i.isDown=movable,i.offset={x:i.offsetLeft-e.clientX,y:i.offsetTop-e.clientY}},!0),a.addEventListener("mouseup",function(){i.isDown=!1},!0),document.addEventListener("mousemove",function(e){i.isDown&&(e={x:e.clientX,y:e.clientY},i.style.left=e.x+i.offset.x+"px",i.style.top=e.y+i.offset.y+"px")},!0),i.appendChild(a),i.setAttribute("tabindex","0"),i},UI.createGraphs=function(e){e=UI.createEmptyWindow("sgvUIwindow",e,"graphs",!1);return e.innerHTML+='<div class="content"></div>',document.body.appendChild(e),e},UI.createTransparentBtn=function(e,t,n){e=UI.tag("input",{type:"button",value:e,class:"sgvTransparentButton1",id:t});return"function"==typeof n&&e.addEventListener("click",function(){n()}),e},UI.createTransparentBtn1=function(e,t,n){t=UI.tag("button",{class:"sgvTransparentButton1",id:t});return t.appendChild(UI.tag("span",{},{innerHTML:e})),"function"==typeof n&&t.addEventListener("click",function(){n()}),t};const DEFAULT_SCOPE="default";var getRandom=function(e,t){return e+Math.random()*(t-e)},sgv="undefined"==typeof exports?function(){}:exports,ParserTXT=("undefined"!=typeof global&&(global.sgv=sgv),sgv.version="1.0.0",sgv.engine=null,sgv.scene=null,sgv.camera=null,sgv.graf=null,sgv.displayMode="classic",sgv.createScene=function(){var e;sgv.scene=new BABYLON.Scene(sgv.engine),sgv.camera=new BABYLON.ArcRotateCamera("Camera",0,0,10,new BABYLON.Vector3(0,0,0),sgv.scene),sgv.camera.setPosition(new BABYLON.Vector3(166,150,0)),sgv.camera.attachControl(sgv.canvas,!0),sgv.camera.inputs.attached.pointers.panningSensibility=25,sgv.camera.upperBetaLimit=Math.PI/2*.99,sgv.camera.inertia=.5,(e=new BABYLON.HemisphericLight("HemiLight",new BABYLON.Vector3(0,1,0),sgv.scene)).intensity=.75,e.parent=sgv.camera,e.position=new BABYLON.Vector3(0,0,0),sgv.SPS=new SPS(sgv.scene),sgv.SPS.init(),sgv.nodeToConnect=0,sgv.addEventsListeners(),sgv.scene.clearColor=new BABYLON.Color3(.7,.7,.7)},sgv.switchDisplayMode=function(){"classic"===sgv.displayMode?sgv.displayMode="triangle":"triangle"===sgv.displayMode?sgv.displayMode="diamond":sgv.displayMode="classic",null!==sgv.graf&&sgv.graf.changeDisplayMode()},sgv.addEventsListeners=function(){var a,l,o=null;function r(){var e=sgv.scene.pick(sgv.scene.pointerX,sgv.scene.pointerY,function(e){return e===o});return e.hit?e.pickedPoint:null}function d(e){function t(e){console.log("LEFT"),e.pickInfo.hit?(e=e.pickInfo,"node"===(e=sgv.SPS.onPick(e)).type&&e.id in sgv.graf.nodes?(console.log("Node picked"),0!==sgv.nodeToConnect?(sgv.graf.addEdge(sgv.nodeToConnect,e.id),sgv.nodeToConnect=0,sgv.SPS.refresh()):sgv.dlgNodeProperties.show(e.id,sgv.scene.pointerX,sgv.scene.pointerY)):"edge"===e.type&&e.id in sgv.graf.edges?(console.log("Edge picked"),sgv.dlgEdgeProperties.show(e.id,sgv.scene.pointerX,sgv.scene.pointerY)):(console.log("Unknown mesh picked"),sgv.dlgEdgeProperties.hide(),sgv.dlgNodeProperties.hide())):(console.log("Probably ground picked"),sgv.dlgEdgeProperties.hide(),sgv.dlgNodeProperties.hide())}switch(e.event.button){case 0:t(e);break;case 1:n=e,console.log("MIDDLE"),n.pickInfo.hit&&"node"===(n=sgv.SPS.onPick(n.pickInfo)).type&&n.id in sgv.graf.nodes&&(console.log("Node picked"),0===sgv.nodeToConnect?sgv.nodeToConnect=n.id:(sgv.graf.addEdge(sgv.nodeToConnect,n.id),sgv.nodeToConnect=0,sgv.SPS.refresh()));break;case 2:console.log("RIGHT")}var n}sgv.scene.onPointerObservable.add(function(e){switch(e.type){case BABYLON.PointerEventTypes.POINTERTAP:d(e);break;case BABYLON.PointerEventTypes.POINTERDOUBLETAP:e.pickInfo.hit&&e.pickInfo.pickedMesh!==o&&"edge"===(i=(i=e.pickInfo.pickedMesh).name.split(":"))[0]&&sgv.graf.edgeDoubleClicked(i[1]);break;case BABYLON.PointerEventTypes.POINTERDOWN:e.pickInfo.hit&&e.pickInfo.pickedMesh!==o&&(i=e,console.log("POINTER.DOWN"),l=i.pickInfo.pickedMesh,a=r())&&setTimeout(function(){sgv.camera.detachControl(sgv.canvas)},0),null!==sgv.graf&&sgv.graf.showLabels(!1);break;case BABYLON.PointerEventTypes.POINTERUP:null!==sgv.graf&&sgv.graf.showLabels(!0),a&&(sgv.camera.attachControl(sgv.canvas,!0),a=null);break;case BABYLON.PointerEventTypes.POINTERMOVE:null!==sgv.graf&&a&&(t=r())&&(n=t.subtract(a),"node"===(s=l.name.split(":"))[0])&&(sgv.graf.moveNode(parseInt(s[1],10),n),a=t)}var t,n,s,i})},sgv.display=function(n){void 0!==n&&"object"==typeof n||(n={}),showSplashAndRun(()=>{let e=null;function t(){return new BABYLON.Engine(sgv.canvas,!0,{doNotHandleContextLost:!0,preserveDrawingBuffer:!0,stencil:!0,disableWebGL2Support:!1})}null===(e="target"in n?document.getElementById(n.target):e)&&((e=document.createElement("div")).setAttribute("id","sgvWorkspaceArea"),document.body.appendChild(e)),sgv.canvas=document.createElement("canvas"),sgv.canvas.setAttribute("id","sgvRenderCanvas"),e.appendChild(sgv.canvas),window.initFunction=async function(){if(sgv.engine=await async function(){try{return t()}catch(e){return console.log("the available createEngine function failed. Creating the default engine instead"),t()}}(),!sgv.engine)throw"engine should not be null.";sgv.engine.enableOfflineSupport=!1,sgv.createScene()},initFunction().then(function(){let e=sgv.scene;sgv.engine.runRenderLoop(function(){e&&e.activeCamera&&e.render()})}),window.addEventListener("resize",function(){sgv.engine.resize()}),desktopInit()})},desktopInit=()=>{},enableMenu=(e,t)=>{},{}),ParserGEXF=(ParserTXT.importGraph=e=>{for(var t,n,s,i=new TempGraphStructure,a=[],l=e.split("\n"),o={};0<l.length;)"#"!==l[0][0]?(t=l[0],s=n=void 0,null!==(n=(t=t.trim().split(/\s+/)).length<3||(n=parseInt(t[0],10),s=parseInt(t[1],10),t=parseFloat(t[2],10),isNaN(n))||isNaN(s)?null:{n1:n,n2:s,val:t})&&(a.push(n),n.n1===n.n2?i.addNode1(n.n1,n.val):i.addEdge1(n.n1,n.n2,n.val))):1<(s=l[0].trim().split(/\s+/)).length&&("type"===(t=(t=s[1]).split("="))[0]?o.type=t[1]:"size"===t[0]&&(5<=(t=t[1].split(",")).length?o.size={cols:parseInt(t[0],10),rows:parseInt(t[1],10),lays:parseInt(t[2],10),KL:parseInt(t[3],10),KR:parseInt(t[4],10)}:4===t.length&&(o.size={cols:parseInt(t[0],10),rows:parseInt(t[1],10),lays:1,KL:parseInt(t[2],10),KR:parseInt(t[3],10)}))),l.shift();void 0===o.type?sgv.dlgCreateGraph.show("load",a):sgv.createGraph(o,a)},ParserTXT.importGraphBAK=e=>{for(var t,n,s,i=[],a=e.split("\n"),l={};0<a.length;)"#"!==a[0][0]?(t=a[0],s=n=void 0,null!==(n=(t=t.trim().split(/\s+/)).length<3||(n=parseInt(t[0],10),s=parseInt(t[1],10),t=parseFloat(t[2],10),isNaN(n))||isNaN(s)?null:{n1:n,n2:s,val:t})&&i.push(n)):1<(s=a[0].trim().split(/\s+/)).length&&("type"===(t=(t=s[1]).split("="))[0]?l.type=t[1]:"size"===t[0]&&(5<=(t=t[1].split(",")).length?l.size={cols:parseInt(t[0],10),rows:parseInt(t[1],10),lays:parseInt(t[2],10),KL:parseInt(t[3],10),KR:parseInt(t[4],10)}:4===t.length&&(l.size={cols:parseInt(t[0],10),rows:parseInt(t[1],10),lays:1,KL:parseInt(t[2],10),KR:parseInt(t[3],10)}))),a.shift();void 0===l.type?sgv.dlgCreateGraph.show("load",i):sgv.createGraph(l,i)},ParserTXT.exportGraph=e=>{if(null==e)return null;var t="# type="+e.type+"\n";t+="# size="+e.cols+","+e.rows+","+e.layers+","+e.KL+","+e.KR+"\n";for(const n in e.nodes)t=(t+=n+" "+n+" ")+e.nodes[n].getValue()+"\n";for(const s in e.edges)t=(t+=e.edges[s].begin+" "+e.edges[s].end+" ")+e.edges[s].getValue()+"\n";return t},{}),FileIO=(ParserGEXF.importGraph=e=>{var t="unknown",n={cols:0,rows:0,KL:0,KR:0},s={},i={},a=[];window.DOMParser?(parser=new DOMParser,xmlDoc=parser.parseFromString(e,"text/xml")):((xmlDoc=new ActiveXObject("Microsoft.XMLDOM")).async=!1,xmlDoc.loadXML(e));var l=xmlDoc.getElementsByTagName("attributes");for(let e=0;e<l.length;e++){var o,r,d=l[e].getAttribute("class"),c=l[e].getElementsByTagName("attribute");for(let e=0;e<c.length;e++)"node"===d?(o=function(e){var t,n=e.getAttribute("id");let s=e.getAttribute("title");return s.startsWith("default")?(e=s.split(";"),s=e[0],t=e[1],e=e[2],{id:n,title:s,type:t,size:e}):{id:n,title:s}}(c[e]),s[o.id]=o.title,"type"in o&&(t=o.type),"size"in o&&(o=o.size.split(","),n.cols=parseInt(o[0]),n.rows=parseInt(o[1]),n.lays=parseInt(o[2]),n.KL=parseInt(o[3]),n.KR=parseInt(o[4]))):"edge"===d&&(r={id:(o=c[e]).getAttribute("id"),title:o.getAttribute("title")},i[r.id]=r.title)}var u=xmlDoc.getElementsByTagName("nodes")[0].getElementsByTagName("node");for(let e=0;e<u.length;e++){var p={},g=u[e].getAttribute("id"),g=(p.n1=p.n2=parseInt(g),p.values={},u[e].getElementsByTagName("attvalues"));if(0<g.length){var h=g[0].getElementsByTagName("attvalue");for(let e=0;e<h.length;e++){var v=h[e].getAttribute("value"),f=h[e].getAttribute("for");p.values[s[f]]=parseFloat(v)}}a.push(p)}var y=xmlDoc.getElementsByTagName("edges")[0].getElementsByTagName("edge");for(let e=0;e<y.length;e++){var b={},m=y[e].getAttribute("source"),w=y[e].getAttribute("target"),m=(b.n1=parseInt(m),b.n2=parseInt(w),b.values={},y[e].getElementsByTagName("attvalues"));if(0<m.length){var I=m[0].getElementsByTagName("attvalue");for(let e=0;e<I.length;e++){var C=I[e].getAttribute("value"),N=I[e].getAttribute("for");b.values[i[N]]=parseFloat(C)}}a.push(b)}if("chimera"===t)sgv.graf=Chimera.createNewGraph(n);else{if("pegasus"!==t)return!1;sgv.graf=Pegasus.createNewGraph(n)}for(const S in s)sgv.graf.scopeOfValues.includes(s[S])||sgv.graf.scopeOfValues.push(s[S]);return sgv.graf.createStructureFromDef2(a),sgv.graf.displayValues(),!0},ParserGEXF.exportGraph=function(t){if(null==t)return null;var n='<?xml version="1.0" encoding="UTF-8"?>\n',n=(n=(n=(n+='<gexf xmlns="http://gexf.net/1.2" version="1.2">\n')+"  <meta>\n"+"    <creator>IITiS.pl</creator>\n")+"    <description>SimGraphVisualizer GEXF export</description>\n"+"  </meta>\n")+'  <graph defaultedgetype="undirected">\n'+'    <attributes class="node">\n';for(const i in t.scopeOfValues){let e=t.scopeOfValues[i];"default"===e&&(e+=";"+t.type+";"+t.cols+","+t.rows+","+t.layers+","+t.KL+","+t.KR),n+='      <attribute id="'+i+'" title="'+e+'" type="float"/>\n'}n+="    </attributes>\n    <nodes>\n";for(const a in t.nodes)n+=function(e){let t='      <node id="'+e.id+'">\n';t+="        <attvalues>\n";for(const n in this.values)t+='          <attvalue for="'+e.parentGraph.getScopeIndex(n)+'" value="'+e.values[n]+'"/>\n';return t=t+"        </attvalues>\n"+"      </node>\n"}(t.nodes[a]);n+='    </nodes>\n    <attributes class="edge">\n';for(const l in t.scopeOfValues){var e=t.scopeOfValues[l];n+='      <attribute id="'+l+'" title="'+e+'" type="float"/>\n'}n+="    </attributes>\n    <edges>\n";let s=0;for(const o in t.edges)n+=function(e,t){let n='      <edge id="'+t+'" source="'+e.begin+'" target="'+e.end+'">\n';n+="        <attvalues>\n";for(const s in e.values)n+='          <attvalue for="'+e.parentGraph.getScopeIndex(s)+'" value="'+e.values[s]+'"/>\n';return n=n+"        </attvalues>\n"+"      </edge>\n"}(t.edges[o],++s);return n=(n+="    </edges>\n")+"  </graph>\n"+"</gexf>\n"},{});function showSplash(){sgv.dlgLoaderSplash.show()}function hideSplash(){setTimeout(function(){sgv.dlgLoaderSplash.hide()},200)}function showSplashAndRun(e,t){void 0===t&&(t=!1),showSplash(),setTimeout(()=>{e(),t||hideSplash()},100)}FileIO.onLoadButton=()=>{let t=UI.tag("input",{type:"file",id:"inputfile",display:"none"});t.addEventListener("change",e=>{void 0!==t.files[0]&&showSplashAndRun(()=>{FileIO.loadGraph(t.files[0])})}),t.click()},FileIO.onSaveButton=()=>new Promise((n,s)=>{"function"==typeof window.showSaveFilePicker?window.showSaveFilePicker({suggestedName:"name.txt",excludeAcceptAllOption:!0,types:[{description:"Text file",accept:{"text/plain":[".txt"]}},{description:"GEXF files",accept:{"application/xml":[".gexf"]}}]}).then(e=>{let t;e.name.endsWith(".txt")?t=new Blob([ParserTXT.exportGraph(sgv.graf)]):e.name.endsWith(".gexf")?t=new Blob([ParserGEXF.exportGraph(sgv.graf)]):s("point 1"),e.createWritable().then(e=>{e.write(t).then(()=>{e.close(),n("point 3 (OK)")})}).catch(()=>{s("point 5")})}).catch(()=>{s("point 2")}):(sgv.dlgAlternateFileSave.show(),n("point 4 (OK)"))}),FileIO.download=(e,t,n)=>{var s=document.createElement("a"),e=new Blob([e],{type:n});s.href=URL.createObjectURL(e),s.download=t,s.click()},FileIO.alternateSave=(e,t)=>{var n;".txt"===t?(n=ParserTXT.exportGraph(sgv.graf),FileIO.download(n,e+t,"text/plain")):".gexf"===t&&(n=ParserGEXF.exportGraph(sgv.graf),FileIO.download(n,e+t,"application/xml"))},sgv.stringToScope=(e,t)=>{sgv.graf.loadScopeValues(t,e).n&&sgv.dlgCPL.addScope(t),sgv.dlgCPL.selScope(t)},FileIO.loadGraph=function(e){const t=e.name,n=new FileReader;e&&(n.addEventListener("error",()=>{console.error("Error occurred reading file: "+e.name)}),n.addEventListener("load",()=>{FileIO.loadGraph2(t,n.result)}),t.endsWith("txt")||t.endsWith("gexf")?n.readAsText(e):console.error("Incorrect file extension..."))},FileIO.loadGraph2=function(e,t){e.endsWith("txt")?(null!==sgv.graf&&sgv.removeGraph(),ParserTXT.importGraph(t)):e.endsWith("gexf")&&(null!==sgv.graf&&sgv.removeGraph(),ParserGEXF.importGraph(t))&&sgv.setModeDescription()},sgv.dlgCPL=new function(){var t,s,i,a,l,o,r,d,n=function(){let n=UI.tag("dialog",{class:"sgvUIwindow disable-select",id:"sgvDlgCPL"});s=function(){var e=UI.tag("div",{class:"content",id:"graphSelection"});return e.appendChild(UI.createTransparentBtn1("show console","cplShowConsoleButton",()=>{sgv.dlgConsole.switchConsole()})),e.appendChild(UI.createTransparentBtn1("create graph","cplCreateButton",()=>{sgv.dlgCreateGraph.show()})),e.appendChild(UI.createTransparentBtn1("load graph","cplLoadButton",()=>{FileIO.onLoadButton()})),e.style.display="block",e}(),i=function(){var e=UI.tag("div",{class:"content",id:"graphDescription"}),t=(e.appendChild(((t=UI.tag("div",{})).innerHTML="Current graph type: ",t.appendChild(UI.span("unknown",{id:"dscr_type"})),t.innerHTML+=', size: <span id="dscr_cols">0</span>x<span id="dscr_rows">0</span>xK<sub><span id="dscr_KL">0</span>,<span id="dscr_KR">0</span></sub><br/>                         Number of nodes: <span id="dscr_nbNodes">0</span>, number of edges: <span id="dscr_nbEdges">0</span>',t)),UI.tag("div",{class:"sgvD1",id:"cplDivNS"},{textContent:"add new scope: "})),n=(t.appendChild(UI.tag("input",{type:"button",class:"sgvC",id:"cplSkipAddScope",value:"<"})),t.appendChild(UI.tag("input",{type:"text",id:"cplAddScopeInput",value:"newScope"})),t.appendChild(UI.tag("input",{type:"button",class:"sgvC",id:"cplAcceptAddScope",value:"+"})),t.style.display="none",UI.tag("div",{class:"sgvD1",id:"cplDivDS"},{textContent:"current scope: "})),s=((a=UI.tag("select",{id:"cplDispValues"})).addEventListener("change",()=>{sgv.graf.displayValues(a.value),u()}),n.appendChild(a),n.appendChild(UI.tag("input",{type:"button",class:"sgvC",id:"cplAddScope",value:"+"})),n.appendChild(UI.tag("input",{type:"button",class:"sgvC",id:"cplDelScope",value:"-"})),UI.tag("div",{class:"sgvSelectBox",id:"cplScope"})),n=(s.appendChild(t),s.appendChild(n),e.appendChild(s),(t=UI.tag("div",{id:"panelLimitSliders"})).appendChild(r=UI.tag("span",{id:"spanRed"},{textContent:"-1.0"})),(l=UI.tag("input",{type:"range",class:"graphLimit",id:"redLimit",value:"-1.0",min:"-1.0",max:"0.0",step:"0.01"})).addEventListener("input",async e=>{null!==sgv.graf&&(sgv.graf.redLimit=e.target.value,r.textContent=sgv.graf.redLimit+" ",sgv.graf.displayValues())}),t.appendChild(l),t.appendChild(UI.tag("span",{id:"spanZero"},{textContent:" 0 "})),(o=UI.tag("input",{type:"range",class:"graphLimit",id:"greenLimit",value:"1.0",min:"0.0",max:"1.0",step:"0.01"})).addEventListener("input",async e=>{null!==sgv.graf&&(sgv.graf.greenLimit=e.target.value,d.textContent=" "+sgv.graf.greenLimit,sgv.graf.displayValues())}),t.appendChild(o),t.appendChild(d=UI.tag("span",{id:"spanGreen"},{textContent:"1.0"})),t);return e.appendChild(n),(s=UI.tag("div",{id:"panelBtns"})).appendChild(UI.createTransparentBtn1("display mode","cplDispModeButton",()=>{sgv.switchDisplayMode()})),s.appendChild(UI.createTransparentBtn1("cell view","cplCellViewButton",()=>{sgv.dlgCellView.switchDialog()})),s.appendChild(UI.createTransparentBtn1("show console","cplShowConsoleButton",()=>{sgv.dlgConsole.switchConsole()})),s.appendChild(UI.createTransparentBtn1("save graph","cplSaveButton",()=>{FileIO.onSaveButton().then(e=>console.log(e)).catch(e=>console.log(e))})),s.appendChild(UI.createTransparentBtn1("delete graph","cplClearButton",()=>{sgv.removeGraph()})),e.appendChild(s),e.style.display="none",e}(),(t=UI.tag("div",{})).style.display="block",t.appendChild(s),t.appendChild(i),n.appendChild(t),n.querySelector("#cplSkipAddScope").addEventListener("click",function(){n.querySelector("#cplDivNS").style.display="none",n.querySelector("#cplDivDS").style.display="block"}),n.querySelector("#cplAcceptAddScope").addEventListener("click",function(){var e=n.querySelector("#cplAddScopeInput").value,t=sgv.graf.addScopeOfValues(e);0<=t&&(n.querySelector("#cplDispValues").add(UI.option(e,e)),n.querySelector("#cplDispValues").selectedIndex=t,sgv.graf.displayValues(e)),n.querySelector("#cplDivNS").style.display="none",n.querySelector("#cplDivDS").style.display="inline"}),n.querySelector("#cplAddScope").addEventListener("click",function(){n.querySelector("#cplDivNS").style.display="inline",n.querySelector("#cplDivDS").style.display="none"}),n.querySelector("#cplDelScope").addEventListener("click",function(){var e=n.querySelector("#cplDispValues"),t=sgv.graf.delScopeOfValues(e.value);0<=t&&(e.remove(e.selectedIndex),e.selectedIndex=t)});var e=UI.tag("div",{id:"switch"});return e.addEventListener("click",()=>{c()}),e.innerHTML=". . .",n.appendChild(e),n.style.display="block",n}();function c(){t.style.display="none"===t.style.display?"block":"none"}function u(){var e,t;null!==sgv.graf&&(0<(e=sgv.graf.getMinMaxVal()).min&&(e.min=Number.NaN),e.max<0&&(e.max=Number.NaN),t=e.min,isNaN(t)?(l.disabled="disabled",r.textContent="NaN"):(t=Math.floor(100*t)/100,sgv.graf.redLimit<t&&(sgv.graf.redLimit=t),l.min=t,l.value=sgv.graf.redLimit,r.textContent=sgv.graf.redLimit+" ",l.disabled=""),t=e.max,isNaN(t)?(o.disabled="disabled",d.textContent="NaN"):(t=Math.ceil(100*t)/100,sgv.graf.greenLimit>t&&(sgv.graf.greenLimit=t),o.max=t,o.value=sgv.graf.greenLimit,d.textContent=" "+sgv.graf.greenLimit,o.disabled=""))}return window.addEventListener("load",()=>{window.document.body.appendChild(n)}),{desc:i,show:function(){u(),t.style.display="block"},hide:function(){t.style.display="none"},switchPanel:c,setModeDescription:function(){if(u(),n.querySelector("#dscr_type").textContent=sgv.graf.type,n.querySelector("#dscr_cols").textContent=sgv.graf.cols,n.querySelector("#dscr_rows").textContent=sgv.graf.rows,n.querySelector("#dscr_KL").textContent=sgv.graf.KL,n.querySelector("#dscr_KR").textContent=sgv.graf.KR,n.querySelector("#dscr_nbNodes").textContent=Object.keys(sgv.graf.nodes).length,n.querySelector("#dscr_nbEdges").textContent=Object.keys(sgv.graf.edges).length,null!==sgv.graf){UI.clearSelect(a,!0);for(const t in sgv.graf.scopeOfValues){var e=sgv.graf.scopeOfValues[t],e=UI.option(e,e);sgv.graf.currentScope===sgv.graf.scopeOfValues[t]&&(e.selected="selected"),a.appendChild(e)}}enableMenu("menuGraphSave",!0),enableMenu("menuGraphClear",!0),enableMenu("menuViewDisplayMode",!0),s.style.display="none",i.style.display="block"},setModeSelection:function(){s.style.display="block",i.style.display="none",enableMenu("menuGraphSave",!1),enableMenu("menuGraphClear",!1),enableMenu("menuViewDisplayMode",!1)},updateSliders:u,addScope:function(e,t){a.add(UI.option(e,e)),a.selectedIndex=t},delScope:function(e,t){-1<(e=UI.findOption(a,e))&&a.remove(e),a.selectedIndex=t},selScope:function(e){-1<(e=UI.findOption(a,e))&&(a.selectedIndex=e)}}},sgv.setModeSelection=sgv.dlgCPL.setModeSelection,sgv.setModeDescription=sgv.dlgCPL.setModeDescription,sgv.removeGraph=function(){null!==sgv.graf&&(sgv.graf.dispose(),sgv.graf=null),sgv.dlgMissingNodes.delAll(),sgv.setModeSelection()},sgv.createGraph=function(e,t){switch(null!==sgv.graf&&sgv.removeGraph(),e.type){case"chimera":sgv.graf=Chimera.createNewGraph(e.size);break;case"pegasus":sgv.graf=Pegasus.createNewGraph(e.size);break;default:return}void 0===t?sgv.graf.createDefaultStructure(()=>{sgv.setModeDescription(),sgv.graf.displayValues(),hideSplash()}):(sgv.graf.createStructureFromDef(t),sgv.setModeDescription(),sgv.graf.displayValues(),hideSplash())},sgv.dlgConsole=new function(){var s=[],i=-1,e=function(e){e=UI.createEmptyWindow("sgvUIwindow",e,"console",!0);return e.innerHTML+='<div class="content">                 <textarea id="consoleHistory" readonly></textarea>                 <input type="text" id="commandline">             </div>',e}("sgvConsole");{let n=e.querySelector("#commandline");n.addEventListener("keydown",function(e){var t;"Enter"===e.key?((t=document.getElementById("consoleHistory")).textContent+="> "+n.value+"\n",t.textContent+=function(e){function t(t){if(null===sgv.graf)return"no graph defined";t=t.split("=");if(console.log(t),t.length<2)return"too few arguments";var e=parseFloat(t[1].replace(/,/g,".")),t=t[0].split("+");if(1===t.length)return i=e,"q"===(s=t)[0][0]?(s=parseInt(s[0].slice(1),10),isNaN(s)||0===s||s>sgv.graf.maxNodeId()?"bad node Id":isNaN(i)?s in sgv.graf.nodes?(sgv.graf.delNode(s.toString()),"deleted node q"+s):"node q"+s+" already deleted":s in sgv.graf.nodes?(sgv.graf.setNodeValue(s,i),"modified node q"+s+" = "+i):s in sgv.graf.missing?(sgv.graf.restoreNode(s),(n=document.getElementById("rest"+s)).parentNode.removeChild(n),sgv.graf.setNodeValue(s,i),"restored and modified node q"+s+" = "+i):(sgv.graf.addNode(s,sgv.graf.calcPosition(s),i),"added node q"+s+" = "+i)):void 0;if(2!==t.length)return"bad arguments";var n=t,s=e;if("q"===n[0][0]&&"q"===n[1][0]){var i=parseInt(n[0].slice(1),10),t=parseInt(n[1].slice(1),10);if(isNaN(i)||0===i)return"bad node Id: "+n[0];if(isNaN(t)||0===t)return"bad node Id: "+n[1];let e=t<i?t+","+i:i+","+t;return isNaN(s)?e in sgv.graf.edges?(sgv.graf.delEdge(e),"deleted edge "+e):"edge "+e+" not exists":e in sgv.graf.edges?(sgv.graf.setEdgeValue(e,s),"modified edge "+e):i in sgv.graf.nodes&&t in sgv.graf.nodes?(sgv.graf.addEdge(i,t).setValue(s),"added edge "+e):"NOT DONE: both connected nodes must exist in the graph"}}function n(e){switch(e){case"set":return"Set or remove value of node or edge\n\nset [nodeId](=value)\nset [nodeId]+[nodeId](=value)";case"create":return"Create new default graph\n\ncreate [chimera|pegasus] [4|8|12|16],[4|8|12|16],[1..4],[1..4]";case"clear":return"Remove current graph if exists\n\nclear";case"display":return"Switch between sets of displayed values\n\ndisplay [valueId]";case"displaymode":return"Set style of graph display.\n\ndisplaymode [classic|triangle|diamond]";default:return"For more information on a specific command, type: help command-name\n\nset\t\tSet or remove value of node or edge\ncreate\t\tCreate new default graph\nclear\t\tRemove current graph if exists\ndisplay\t\tSwitch between sets of displayed values\ndisplaymode\tSet style of graph display"}}var s=(e=e.trim().toLowerCase().replace(/\s+/g," ")).split(" ");var i=e.indexOf(" ");var a=e.substring(i+1).replace(/\s+/g,""),l="";switch(s[0].trim()){case"help":case"?":l=n(s[1]);break;case"limits":l=function(e){if(null===sgv.graf)return"no graph defined";let t="";var n;return 1===e.length?(t="Current display limits [red, green] are set to ["+sgv.graf.redLimit+", "+sgv.graf.greenLimit+"]\n",n=sgv.graf.getMinMaxNodeVal(),t+="\nnode values range in current scope is: ["+n.min+", "+n.max+"] "+n.com,n=sgv.graf.getMinMaxEdgeVal(),t+="\nedge weights range in current scope is: ["+n.min+", "+n.max+"] "+n.com):"set"!==e[1]?"bad arguments":e.length<4?"too few arguments\nUse: limits set <min> <max>":(n=parseFloat(e[2].replace(/,/g,".")),e=parseFloat(e[3].replace(/,/g,".")),isNaN(n)||isNaN(e)?"Bad arguments: <min> and <max> should be numbers.":0<n||e<0||n===e?"Bad arguments: <min> cannot be greater than zero, <max> cannot be less than zero and both values cannot be zero at the same time.":(sgv.graf.redLimit=n,sgv.graf.greenLimit=e,t="Display limits [red, green] are set to ["+sgv.graf.redLimit+", "+sgv.graf.greenLimit+"]",sgv.graf.displayValues(sgv.graf.currentScope),t))}(s);break;case"create":l=function(e,t){if(null!==sgv.graf)return"graf exists, type: clear <Enter> to delete it";switch(t=t.split(","),size={cols:parseInt(t[0],10),rows:parseInt(t[1],10),KL:parseInt(t[2],10),KR:parseInt(t[3],10)},e){case"chimera":sgv.graf=Chimera.createNewGraph(size),sgv.graf.createDefaultStructure();break;case"pegasus":sgv.graf=Pegasus.createNewGraph(size),sgv.graf.createDefaultStructure();break;default:return"unknown graph type"}return sgv.setModeDescription(),"graph created"}(s[1],s[2]);break;case"clear":sgv.removeGraph(),l="graph removed";break;case"set":l=t(a);break;case"scope":l=function(e,t){if(null===sgv.graf)return"no graph defined";switch(e){case"list":return sgv.graf.scopeOfValues.toString();case"add":var n=sgv.graf.addScopeOfValues(t);return 0<=n&&(sgv.dlgCPL.addScope(t,n),sgv.graf.displayValues(t)),"Added scope "+t;case"delete":n=sgv.graf.delScopeOfValues(t);return 0<=n?(sgv.dlgCPL.delScope(t,n),"Deleted scope "+t+", current scope: "+sgv.graf.currentScope):"Scope "+t+" could not to be deleted... Current scope: "+sgv.graf.currentScope;case"set":return sgv.graf.hasScope(t)?(sgv.graf.displayValues(t)&&sgv.dlgCPL.selScope(t),"Current scope: "+sgv.graf.currentScope):"Bad scope name: "+t+"... Current scope: "+sgv.graf.currentScope;default:return"Current scope: "+sgv.graf.currentScope}}(s[1],s[2]);break;case"display":l=function(e){return"displayed value: "+sgv.graf.displayValues(e)}(s[1]);break;case"displaymode":l="classic"===s[1]||"diamond"===s[1]||"triangle"===s[1]?(sgv.displayMode=s[1],sgv.graf.changeDisplayMode(),"current displayMode = "+s[1]):"unknown mode\n\n"+n("displaymode");break;default:l="unknown command\n\n"+n()}return l}(n.value)+"\n",t.scrollTop=t.scrollHeight,10<s.length&&s.shift(),s.push(n.value),i=s.length,n.value=""):38===e.keyCode?0<i&&(i--,n.value=s[i]):40===e.keyCode&&(i<s.length?(n.value=s[i],i++):n.value="")}),e.querySelector(".hidebutton").addEventListener("click",function(){sgv.dlgConsole.hideConsole()})}return window.addEventListener("load",()=>{window.document.body.appendChild(e)}),{switchConsole:function(){"block"!==e.style.display?e.style.display="block":e.style.display="none"},showConsole:function(){e.style.display="block"},hideConsole:function(){e.style.display="none"}}},sgv.dlgCellView=new function(){var N,S,L,x,E,B,V,U,t=null;const k=600,O=600,s=k/2,i=O/2,d="http://www.w3.org/2000/svg";B=V=U=0,(e=UI.createEmptyWindow("sgvUIwindow","sgvdlgCellView","Cell view",!0)).querySelector(".hidebutton").addEventListener("click",function(){g()}),(n=UI.tag("div",{class:"content",id:"graphSelection"})).appendChild(UI.tag("div",{id:"description"})),(a=UI.tag("div",{id:"description"})).style["text-align"]="center",(N=UI.tag("select",{id:"graphCols"})).addEventListener("change",()=>{o(parseInt(N.value,10),parseInt(S.value,10),parseInt(L.value,10))}),a.appendChild(UI.tag("label",{for:"graphCols"},{innerHTML:" column: "})),a.appendChild(N),(S=UI.tag("select",{id:"graphRows"})).addEventListener("change",()=>{o(parseInt(N.value,10),parseInt(S.value,10),parseInt(L.value,10))}),a.appendChild(UI.tag("label",{for:"graphRows"},{innerHTML:" row: "})),a.appendChild(S),(L=UI.tag("select",{id:"graphLays"})).addEventListener("change",()=>{o(parseInt(N.value,10),parseInt(S.value,10),parseInt(L.value,10))}),a.appendChild(UI.tag("label",{for:"graphLays"},{innerHTML:" layer: "})),a.appendChild(L),(x=UI.tag("select",{id:"selectScope"})).addEventListener("change",()=>{sgv.graf.displayValues(x.value),sgv.dlgCPL.selScope(x.value),sgv.dlgCPL.updateSliders(),o()}),a.appendChild(UI.tag("label",{for:"selectScope"},{innerHTML:" scope: "})),a.appendChild(x),n.appendChild(a),(a=UI.tag("div")).style.width="fit-content",a.style.height="fit-content",a.style.background="#fff",a.style.border="0",a.style.margin="0",a.style.padding="0",(E=document.createElementNS(d,"svg")).setAttributeNS(null,"id","svgView"),E.setAttributeNS(null,"height",O),E.setAttributeNS(null,"width",k),E.addEventListener("click",e=>{"svgView"===e.target.id&&(sgv.dlgNodeProperties.hide(),sgv.dlgEdgeProperties.hide())}),a.appendChild(E),n.appendChild(a),e.appendChild(n),e.style.display="none",e.style.top="10vh",e.style.left="10vh";var e,n,a,l=e;function A(e,t){var n={classic:[{x:-60,y:150},{x:-90,y:50},{x:-120,y:-50},{x:-150,y:-150},{x:140,y:200},{x:110,y:100},{x:80,y:0},{x:50,y:-100}]};return t="classic",{x:s+n[t][e].x,y:i+n[t][e].y}}function r(e){e.preventDefault();var t=e.target.id.split("_"),t=(id=1<t.length?t[1]:e.target.id,QbDescr.fromNodeId(id,sgv.graf.rows,sgv.graf.cols));o(t.x,t.y,t.z)}function c(e){e.preventDefault();var t=e.target.id.split("_"),n=e.target.getBoundingClientRect();1<t.length?sgv.dlgNodeProperties.show(t[1],n.x,n.y):sgv.dlgNodeProperties.show(e.target.id,n.x,n.y)}function M(e){e.preventDefault();var t=e.target.id.split("_"),n=e.target.getBoundingClientRect();1<t.length?sgv.dlgEdgeProperties.show(t[1],n.x,n.y):sgv.dlgEdgeProperties.show(e.target.id,n.x,n.y)}function u(e,t,n,s,i,a,l){var o=document.createElementNS(d,"text");o.setAttributeNS(null,"id","text_"+e),o.setAttributeNS(null,"x",t),o.setAttributeNS(null,"y",n),o.setAttributeNS(null,"text-anchor","middle"),o.setAttributeNS(null,"alignment-baseline","middle"),o.setAttributeNS(null,"font-size","12px"),o.setAttributeNS(null,"font-family","Arial, Helvetica, sans-serif"),o.setAttributeNS(null,"fill",i),o.textContent=s,E.appendChild(o),o.addEventListener("click",l),""!==a&&((i=document.createElementNS(d,"rect")).setAttributeNS(null,"id","textBG_"+e),i.setAttributeNS(null,"x",t-12),i.setAttributeNS(null,"y",n-8),i.setAttributeNS(null,"width",24),i.setAttributeNS(null,"height",14),i.setAttributeNS(null,"fill",a),E.insertBefore(i,o),i.addEventListener("click",l))}function T(e,t,n,s,i,a,l,o){var r=document.createElementNS(d,"line");r.setAttributeNS(null,"id","edge_"+e),r.setAttributeNS(null,"x1",t),r.setAttributeNS(null,"y1",n),r.setAttributeNS(null,"x2",s),r.setAttributeNS(null,"y2",i),r.setAttributeNS(null,"stroke",a),r.setAttributeNS(null,"stroke-width",l),E.appendChild(r),r.addEventListener("click",o)}function P(e,t,n,s,i){var a,l,o,e=Edge.calcId(e+t,n);e in sgv.graf.edges&&(a=valueToColor(l=sgv.graf.edgeValue(e)),l=2+5*valueToEdgeWidth(l),o=valueToColor(sgv.graf.nodeValue(n)),T(e,A(t).x,A(t).y,s,i,a.toHexString(),l,M),u(n,s,i,n,"yellow",o.toHexString(),r))}function D(e,t){var n,s,i,a,l,o,r,e=e+t;e in sgv.graf.nodes&&(l=valueToColor(sgv.graf.nodeValue(e)),n=e,s=A(t).x,i=A(t).y,a=20,l=l.toHexString(),o=c,(r=document.createElementNS(d,"circle")).setAttributeNS(null,"id","node_"+n),r.setAttributeNS(null,"cx",s),r.setAttributeNS(null,"cy",i),r.setAttributeNS(null,"r",a),r.setAttributeNS(null,"fill",l),r.setAttributeNS(null,"stroke","black"),r.setAttributeNS(null,"stroke-width","1"),E.appendChild(r),r.addEventListener("click",o),u(e,A(t).x,A(t).y,e.toString(),"yellow","",c))}function o(e,t,n){if(E.innerHTML="",null!==sgv.graf){void 0===e?e=V:V=e<sgv.graf.cols?e:e=0,void 0===t?t=B:B=t<sgv.graf.rows?t:t=0,void 0===n?n=U:U=n<sgv.graf.layers?n:n=0;sgv.graf.rows,sgv.graf.cols;UI.selectByKey(N,e),UI.selectByKey(S,t),UI.selectByKey(L,n),UI.selectByKey(x,sgv.graf.currentScope),e=e,t=t,n=(n=n)*sgv.graf.cols*sgv.graf.rows,n=8*((n+=t*sgv.graf.cols)+e);var s,i,a,l,o,r=++n,d=k-20,c=O-20,u=[{x:115,y:-40},{x:75,y:-40},{x:45,y:-30},{x:45,y:-10},{x:45,y:10},{x:45,y:30},{x:75,y:40},{x:115,y:40}],p=[{x:d-95,y:-40},{x:d-55,y:-40},{x:d-25,y:-30},{x:d-25,y:-10},{x:d-25,y:10},{x:d-25,y:30},{x:d-55,y:40},{x:d-95,y:40}],g={};for(let t=0;t<8;t++){var h,v,f,y=sgv.graf.findAllConnected(r+t);for(h of y.internal){var b=Edge.calcId(r+t,h);b in g||(s=r,i=t,a=(h-1)%8,o=l=void 0,s=Edge.calcId(s+i,s+a),console.log("eid2: ",s),s in sgv.graf.edges&&(l=valueToColor(o=sgv.graf.edgeValue(s)),o=2+5*valueToEdgeWidth(o),T(s,A(i).x,A(i).y,A(a).x,A(a).y,l.toHexString(),o,M)),g[b]=1)}for(v of y.horizontal)P(r,t,v,r+t<v?d:20,A(t).y);for(f of y.vertical)P(r,t,f,A(t).x,r+t<f?20:c);let e=0;if(t<4){for(var m of y.up)P(r,t,m,u[e].x,A(t).y+u[e].y),e++;for(var w of y.down)P(r,t,w,u[e].x,A(t).y+u[e].y),e++}else{for(var I of y.up)P(r,t,I,p[e].x,A(t).y+p[e].y),e++;for(var C of y.down)P(r,t,C,p[e].x,A(t).y+p[e].y),e++}D(r,t)}}}function p(){UI.clearSelect(N,!0);for(let e=0;e<sgv.graf.cols;e++)N.appendChild(UI.option(e,e));N.selectedIndex=V,UI.clearSelect(S,!0);for(let e=0;e<sgv.graf.rows;e++)S.appendChild(UI.option(e,e));S.selectedIndex=B,UI.clearSelect(L,!0);for(let e=0;e<sgv.graf.layers;e++)L.appendChild(UI.option(e,e));for(var e in L.selectedIndex=U,1===sgv.graf.layers?L.disabled="disabled":L.disabled="",UI.clearSelect(x,!0),sgv.graf.scopeOfValues)x.appendChild(UI.option(sgv.graf.scopeOfValues[e],sgv.graf.scopeOfValues[e]));UI.selectByKey(x,sgv.graf.currentScope),o(),l.style.display="block",t=window.document.activeElement,l.focus({focusVisible:!1})}function g(){null!==t&&t.focus({focusVisible:!1}),l.style.display="none"}return l.addEventListener("keydown",function(e){e=e.key;"ArrowLeft"===e?0<V&&o(V-1,B,U):"ArrowRight"===e?V<sgv.graf.cols-1&&o(V+1,B,U):"ArrowUp"===e?B<sgv.graf.rows-1&&o(V,B+1,U):"ArrowDown"===e?0<B&&o(V,B-1,U):"PageUp"===e?U<sgv.graf.layers-1&&o(V,B,U+1):"PageDown"===e?0<U&&o(V,B,U-1):"Escape"===e&&g()}),window.addEventListener("load",()=>{window.document.body.appendChild(l)}),{refresh:o,switchDialog:function(){("none"===l.style.display?p:g)()},show:p,hide:g}},sgv.dlgCreateGraph=new function(){var s,i,a,l,n=function(){var e=UI.tag("dialog",{class:"sgvUIwindow sgvModalDialog",id:"sgvDlgCreateGraph"}),t=UI.createTitlebar("Create graph",!1),t=(e.appendChild(t),UI.tag("div",{class:"content",id:"graphSelection"})),n=(t.appendChild(UI.tag("div",{id:"description"})),UI.tag("div",{id:"description"}));n.style["text-align"]="center",(l=UI.tag("select",{id:"graphType"})).appendChild(UI.option("chimera","chimera")),l.appendChild(UI.option("pegasus","pegasus")),l.addEventListener("change",e=>{"chimera"===e.target.value?(a.selectedIndex=0,a.disabled="disabled"):a.disabled=""}),n.appendChild(UI.tag("label",{for:"graphType"},{innerHTML:"graph type: "})),n.appendChild(l),n.appendChild(UI.tag("hr")),s=UI.tag("select",{id:"graphCols"});for(let e=1;e<17;e++)s.appendChild(UI.option(e,e));n.appendChild(UI.tag("label",{for:"graphCols"},{innerHTML:" columns: "})),n.appendChild(s),i=UI.tag("select",{id:"graphRows"});for(let e=1;e<17;e++)i.appendChild(UI.option(e,e));n.appendChild(UI.tag("label",{for:"graphRows"},{innerHTML:" rows: "})),n.appendChild(i),(a=UI.tag("select",{id:"graphLays"})).appendChild(UI.option("1","1",!0));for(let e=2;e<10;e++)a.appendChild(UI.option(e,e));return a.disabled="disabled",n.appendChild(UI.tag("label",{for:"graphLays"},{innerHTML:" layers: "})),n.appendChild(a),n.appendChild(UI.tag("hr")),(l=UI.tag("select",{id:"graphKL"})).appendChild(UI.option("1","1")),l.appendChild(UI.option("2","2")),l.appendChild(UI.option("3","3")),l.appendChild(UI.option("4","4",!0)),n.appendChild(UI.tag("label",{for:"graphKL"},{innerHTML:"module size: K = "})),n.appendChild(l),(l=UI.tag("select",{id:"graphKR"})).appendChild(UI.option("1","1")),l.appendChild(UI.option("2","2")),l.appendChild(UI.option("3","3")),l.appendChild(UI.option("4","4",!0)),n.appendChild(UI.tag("label",{for:"graphKR"},{innerHTML:", "})),n.appendChild(l),t.appendChild(n),t.appendChild(UI.tag("div",{id:"buttons"})),e.appendChild(t),e.style.display="none",e}();function o(){n.close(),n.style.display="none"}return window.addEventListener("load",()=>{window.document.body.appendChild(n)}),{show:function(e,t){"load"===e?(n.querySelector("#buttons").innerHTML='<input class="actionbutton" id="cplCancelButton" name="cancelButton" type="button" value="Cancel">                  <input class="actionbutton" id="cplCreateButton" name="createButton" type="button" value="Load">',n.querySelector(".titleText").textContent="Load graph"):(n.querySelector("#buttons").innerHTML='<input class="actionbutton" id="cplCancelButton" name="cancelButton" type="button" value="Cancel">                  <input class="actionbutton" id="cplCreateButton" name="createButton" type="button" value="Create">',n.querySelector(".titleText").textContent="New graph"),n.style.display="block",n.querySelector("#cplCreateButton").addEventListener("click",()=>{showSplashAndRun(()=>{o(),setTimeout(()=>{sgv.createGraph({type:n.querySelector("#graphType").value,size:{cols:parseInt(n.querySelector("#graphCols").value,10),rows:parseInt(n.querySelector("#graphRows").value,10),lays:parseInt(n.querySelector("#graphLays").value,10),KL:parseInt(n.querySelector("#graphKL").value,10),KR:parseInt(n.querySelector("#graphKR").value,10)}},t)},100)},!0)}),n.querySelector("#cplCancelButton").addEventListener("click",()=>{o()}),n.showModal()},hide:o}},sgv.dlgEdgeProperties=new function(){var l,o,r,d,c,u,p,g,e,t,h=null,v=((t=UI.createEmptyWindow("sgvUIwindow","sgvEdgeProperties","Edge properties",!0)).querySelector(".hidebutton").addEventListener("click",function(){s()}),r=UI.newInput("hidden","0","","edgeId"),t.appendChild(r),e=UI.tag("div",{class:"content"}),(d=UI.tag("select",{id:"selectEdgeId"})).appendChild(UI.tag("option",{value:0,selected:!0},{innerHTML:"-- id --"})),d.addEventListener("change",function(){n(event.target.value)}),e.appendChild(UI.tag("label",{for:"selectEdgeId"},{innerHTML:"Edge: "})),e.appendChild(d),t.appendChild(e),l=UI.tag("div",{class:"content"}),t.appendChild(l),l.appendChild(UI.tag("label",{for:"nsSelectE"},{innerHTML:"Scope: "})),(c=UI.tag("select",{id:"nsSelectE"})).addEventListener("change",function(){var e,t;e=event.target.value,t=v.querySelector("#edgeId").value,null===(t=sgv.graf.edgeValue(t,sgv.graf.scopeOfValues[e]))||isNaN(t)?(console.log("NULL"),u.checked="",p.value=null,p.disabled="disabled",g.disabled="disabled"):(console.log("NOT NULL"),u.checked="checked",p.value=t,p.disabled="",g.disabled="")}),l.appendChild(c),l.appendChild(document.createElement("br")),(u=UI.newInput("checkbox","","","valueCheckE")).addEventListener("click",function(){var e=u.checked,t=sgv.graf.scopeOfValues[c.value];if(e){p.disabled="",g.disabled="";let e=parseFloat(p.value.replace(/,/g,"."));""===e&&(e=0,p.value=e),sgv.graf.setEdgeValue(v.querySelector("#edgeId").value,e,t)}else p.disabled="disabled",g.disabled="disabled",sgv.graf.delEdgeValue(v.querySelector("#edgeId").value,t);Dispatcher.graphChanged()}),l.appendChild(u),(p=UI.newInput("number","0","","wagaE")).addEventListener("change",function(){i()}),l.appendChild(p),(g=UI.newInput("button","set","setvaluebutton","setE")).addEventListener("click",function(){i()}),l.appendChild(g),(e=UI.newInput("button","delete","delbutton","")).addEventListener("click",function(){sgv.graf.delEdge(v.querySelector("#edgeId").value),v.style.display="none"}),l.appendChild(e),l.style["min-width"]="240px",l.style["min-height"]="105px",(o=UI.tag("div",{class:"content"})).innerHTML="Select an edge, please.",o.style["min-width"]="240px",o.style["min-height"]="105px",t.appendChild(o),t);function n(e,t,n){if(void 0!==e?(e=e.toString(),r.value=e):e=r.value,"0"===e)l.style.display="none",o.style.display="block";else{o.style.display="none",l.style.display="block",UI.clearSelect(d,!1);for(const i in sgv.graf.edges)d.appendChild(UI.tag("option",{value:i},{innerHTML:"q"+sgv.graf.edges[i].begin+" - q"+sgv.graf.edges[i].end}));UI.selectByKey(d,e),UI.clearSelect(c,!0);for(const a in sgv.graf.scopeOfValues){var s=UI.tag("option",{value:a},{innerHTML:sgv.graf.scopeOfValues[a]});sgv.graf.currentScope===sgv.graf.scopeOfValues[a]&&(s.selected="selected"),c.appendChild(s)}var e=sgv.graf.edgeValue(e);null===e||isNaN(e)?(u.checked="",p.value=null,p.disabled="disabled",g.disabled="disabled"):(u.checked="checked",p.value=e,p.disabled="",g.disabled=""),void 0!==t&&void 0!==n&&(e=sgv.canvas.clientLeft,v.style.top=n+"px",v.style.left=e+t+"px"),v.style.display="block",h=window.document.activeElement,v.focus({focusVisible:!1})}}function s(){null!==h&&h.focus({focusVisible:!1}),null!==v&&(v.style.display="none")}function i(){var e=v.querySelector("#edgeId").value,t=parseFloat(p.value.replace(/,/g,".")),n=sgv.graf.scopeOfValues[c.value];sgv.graf.setEdgeValue(e,t,n),Dispatcher.graphChanged()}return v.addEventListener("keydown",function(e){e=e.key;"Escape"===e&&s()}),window.addEventListener("load",()=>{window.document.body.appendChild(v)}),{show:n,hide:s,isVisible:()=>null!==v&&"block"===v.style.display}},sgv.dlgNodeProperties=new function(){var r,d,c,u,p,g,h,v,e,t,f=null,y=((e=UI.createEmptyWindow("sgvUIwindow","sgvNodeProperties","Node properties",!0)).querySelector(".hidebutton").addEventListener("click",function(){s()}),r=UI.newInput("hidden","0","","nodeId"),e.appendChild(r),t=UI.tag("div",{class:"content"}),(d=UI.tag("select",{id:"selectNodeId"})).appendChild(UI.tag("option",{value:0,selected:!0},{innerHTML:"-- id --"})),d.addEventListener("change",function(){n(event.target.value)}),t.appendChild(UI.tag("label",{for:"selectNodeId"},{innerHTML:"Node: "})),t.appendChild(d),e.appendChild(t),h=UI.tag("div",{class:"content"}),t=UI.tag("div"),(p=UI.newInput("checkbox","","","checkLabelN")).addEventListener("click",function(e){e=e.target.checked;g.disabled=e?"":"disabled",sgv.graf.nodes[r.value].showLabel(e)}),t.appendChild(UI.tag("label",{for:"checkLabelN"},{innerHTML:"Label: "})),t.appendChild(p),(g=UI.newInput("text","","","editLabelN")).addEventListener("change",function(e){sgv.graf.nodes[r.value].setLabel(e.target.value,!0)}),t.appendChild(g),h.appendChild(t),(c=UI.tag("select",{id:"nsSelectN"})).addEventListener("change",function(){var e;console.log("changeScopeN: "+event.target.value),e=y.querySelector("#nodeId").value,null===(e=sgv.graf.nodeValue(e,sgv.graf.scopeOfValues[event.target.value]))||isNaN(e)?(console.log("NULL"),y.querySelector("#valueCheckN").checked="",y.querySelector("#wagaN").value=null,y.querySelector("#wagaN").disabled="disabled",y.querySelector("#setN").disabled="disabled"):(console.log("NOT NULL"),y.querySelector("#valueCheckN").checked="checked",y.querySelector("#wagaN").value=e,y.querySelector("#wagaN").disabled="",y.querySelector("#setN").disabled="")}),h.appendChild(UI.tag("label",{for:"nsSelectN"},{innerHTML:"Scope: "})),h.appendChild(c),h.appendChild(document.createElement("br")),(t=UI.newInput("checkbox","","","valueCheckN")).addEventListener("click",function(){var t=sgv.graf.scopeOfValues[y.querySelector("#nsSelectN").value];if(y.querySelector("#valueCheckN").checked){y.querySelector("#wagaN").disabled="",y.querySelector("#setN").disabled="";let e=parseFloat(y.querySelector("#wagaN").value.replace(/,/g,"."));""===e&&(e=0,y.querySelector("#wagaN").value=e),sgv.graf.setNodeValue(y.querySelector("#nodeId").value,e,t)}else y.querySelector("#wagaN").disabled="disabled",y.querySelector("#setN").disabled="disabled",sgv.graf.delNodeValue(y.querySelector("#nodeId").value,t);Dispatcher.graphChanged()}),h.appendChild(t),(t=UI.newInput("number","0","","wagaN")).addEventListener("change",function(){i()}),h.appendChild(t),(t=UI.newInput("button","set","setvaluebutton","setN")).addEventListener("click",function(){i()}),h.appendChild(t),h.appendChild(document.createElement("br")),(t=UI.newInput("button","connect to...","","connectN")).addEventListener("click",function(){var e,t;e=y.querySelector("#nodeId").value,t=y.querySelector("#destN").value,null!==sgv.graf&&(sgv.graf.addEdge(e,t),Dispatcher.graphChanged())}),h.appendChild(t),u=UI.tag("select",{id:"destN"}),h.appendChild(u),(t=UI.newInput("button","^","","connectSelectN")).addEventListener("click",function(){sgv.nodeToConnect=parseInt(y.querySelector("#nodeId").value,10),y.style.display="none"}),h.appendChild(t),h.appendChild(document.createElement("br")),(btnDeleteNode=UI.newInput("button","delete","delbutton","")).addEventListener("click",function(){sgv.graf.delNode(r.value),y.style.display="none"}),h.appendChild(btnDeleteNode),h.style["min-width"]="240px",h.style["min-height"]="105px",e.appendChild(h),(v=UI.tag("div",{class:"content"})).innerHTML="Select a node, please.",v.style["min-width"]="240px",v.style["min-height"]="105px",e.appendChild(v),e);function n(e,t,n){if(void 0!==e?(e=e.toString(),r.value=e):e=r.value,"0"===e)h.style.display="none",v.style.display="block";else{v.style.display="none",h.style.display="block",r.value=e,g.value=sgv.graf.nodes[e].getLabel(),sgv.graf.nodes[e].isLabelVisible()?(p.checked="checked",g.disabled=""):(p.checked="",g.disabled="disabled"),UI.clearSelect(c,!0);for(const l in sgv.graf.scopeOfValues){var s=UI.tag("option",{value:l},{innerHTML:sgv.graf.scopeOfValues[l]});sgv.graf.currentScope===sgv.graf.scopeOfValues[l]&&(s.selected="selected"),c.appendChild(s)}var i=sgv.graf.nodeValue(e);null===i||isNaN(i)?(y.querySelector("#valueCheckN").checked="",y.querySelector("#wagaN").value=null,y.querySelector("#wagaN").disabled="disabled",y.querySelector("#setN").disabled="disabled"):(y.querySelector("#valueCheckN").checked="checked",y.querySelector("#wagaN").value=i,y.querySelector("#wagaN").disabled="",y.querySelector("#setN").disabled=""),UI.clearSelect(u,!0),UI.clearSelect(d,!1);for(const o in sgv.graf.nodes){var a=o.toString()!==e.toString();d.appendChild(UI.tag("option",{value:o},{innerHTML:"q"+o})),a&&u.appendChild(UI.tag("option",{value:o},{innerHTML:"q"+o}))}UI.selectByKey(d,e),void 0!==t&&void 0!==n&&(i=sgv.canvas.clientLeft,y.style.top=n+"px",y.style.left=i+t+"px"),y.style.display="block",f=window.document.activeElement,y.focus({focusVisible:!1})}}function s(){null!==f&&f.focus({focusVisible:!1}),null!==y&&(y.style.display="none")}function i(){var e=y.querySelector("#nodeId").value,t=parseFloat(y.querySelector("#wagaN").value.replace(/,/g,".")),n=sgv.graf.scopeOfValues[y.querySelector("#nsSelectN").value];sgv.graf.setNodeValue(e,t,n),Dispatcher.graphChanged()}return y.addEventListener("keydown",function(e){e=e.key;"Escape"===e&&s()}),window.addEventListener("load",()=>{window.document.body.appendChild(y)}),{show:n,hide:s,isVisible:()=>null!==y&&"block"===y.style.display}},sgv.dlgAlternateFileSave=new function(){s=UI.tag("dialog",{class:"sgvUIwindow sgvModalDialog",id:"sgvDlgAltSaveGraph"}),i=UI.createTitlebar("Save graph",!1),s.appendChild(i),(content=UI.tag("div",{class:"content"})).appendChild(UI.tag("div",{},{style:"max-width:400px",textContent:"Your browser does not allow us to open the system window for selecting a file to save. Please select the file format and its name and click Save button. Depending on your browser's settings, the file will be saved in the default location (usually: Downloads) or a selection window will appear."})),content.appendChild(UI.tag("hr")),i=UI.tag("div"),(n=UI.tag("select",{id:"savSelectType"})).appendChild(UI.option(".txt","TXT")),n.appendChild(UI.option(".gexf","GEXF")),n.addEventListener("change",e=>{t.textContent=e.target.value}),i.appendChild(UI.tag("label",{for:"savSelectType"},{innerHTML:"Select format: "})),i.appendChild(n),content.appendChild(i),i=UI.tag("div"),e=UI.tag("input",{type:"text",id:"savSelectName",value:"filename"}),i.appendChild(UI.tag("label",{for:"savSelectname"},{innerHTML:"Select filename: "})),i.appendChild(e),t=UI.tag("span",{},{textContent:".txt"}),i.appendChild(t),content.appendChild(i),(n=UI.newInput("button","cancel","actionbutton","")).addEventListener("click",function(){l()}),content.appendChild(n),(i=UI.newInput("button","save","actionbutton","")).addEventListener("click",function(){FileIO.alternateSave(e.value,t.textContent),l()}),content.appendChild(i),s.appendChild(content),s.style.display="none";var e,t,n,s,i,a=s;function l(){a.close(),a.style.display="none"}return window.addEventListener("load",()=>{window.document.body.appendChild(a)}),{show:function(){a.style.display="block",a.showModal()},hide:l}},sgv.dlgMissingNodes=new function(){e="sgvMissingNodes",e=UI.createEmptyWindow("sgvUIwindow",e,"removed nodes",!0),t=UI.tag("div",{class:"content"}),n=UI.tag("div",{id:"misN"}),t.appendChild(n),(s=UI.newInput("button","clear history","delbutton","")).addEventListener("click",function(){l()}),t.appendChild(s),e.appendChild(t);var n,e,t,s,i=e;function a(e){return!!sgv.graf.restoreNode(e)&&((e=i.querySelector("#rest"+e)).parentNode.removeChild(e),!0)}function l(){n.innerHTML="",null!==sgv.graf&&(sgv.graf.missing={}),i.style.display="none"}return window.addEventListener("load",()=>{window.document.body.appendChild(i)}),{show:()=>{i.style.display="block"},hide:()=>{i.style.display="none"},addNode:function(e){var t=UI.newInput("button"," q"+e+" ","","rest"+e);t.addEventListener("click",function(){a(e)}),n.appendChild(t),i.style.display="block"},restoreNode:a,delAll:l}},sgv.dlgAbout=new function(){var n=null;function e(){null===n&&(n=UI.tag("dialog",{class:"sgvUIwindow sgvModalDialog",id:"sgvDlgAbout"}));var e=UI.tag("div",{class:"content"}),t=(e.style["text-align"]="center",e.style.width="fit-content",e.innerHTML+='<div><img src="pics/EuroHPC.jpg"></div>',e.innerHTML+="<div>Narodowa Infrastruktura Superkomputerowa dla EuroHPC - EuroHPC PL</div>",e.innerHTML+='<div class="info">simGraphVisualizer v.1.0</div>',e.innerHTML+='<div><img src="pics/Flagi.jpg"></div>',UI.tag("input",{type:"button",value:"Close",class:"actionbutton",id:"closeButton",name:"closeButton"})),t=(e.appendChild(t),t.addEventListener("click",function(){s()}),UI.createTitlebar("About",!1));n.appendChild(t),n.appendChild(e),n.style.display="none",window.document.body.appendChild(n)}function s(){n.close(),n.style.display="none"}return{create:e,show:function(){null===n&&e(),n.style.display="block",n.showModal()},hide:s}},sgv.dlgLoaderSplash=new function(){var n,s=null;return{setInfo:function(e,t){s.open&&s.close(),s.style.display="block",s.showModal(),n.innerHTML=e,"function"==typeof t&&setTimeout(()=>{t()},100)},show:function(){null===s&&((s=null===s?UI.tag("dialog",{class:"sgvModalDialog",id:"loaderSplash"}):s).appendChild(UI.tag("span",{},{textContent:"working hard for you"})),s.appendChild(UI.tag("div",{class:"loader"})),s.appendChild(UI.tag("span",{},{textContent:"... please wait ..."})),s.appendChild(n=UI.tag("div",{id:"infoBlock"})),s.style.display="none",window.document.body.appendChild(s)),s.open&&s.close(),s.style.display="block",s.showModal()},hide:function(){s.close(),s.style.display="none"}}};